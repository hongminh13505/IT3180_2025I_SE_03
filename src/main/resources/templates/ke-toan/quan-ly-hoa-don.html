<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω h√≥a ƒë∆°n - Qu·∫£n l√Ω chung c∆∞</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>BLUE MOON</h3>
                <p class="role-badge">K·∫ø to√°n</p>
            </div>
            
            <nav class="sidebar-menu">
                <ul>
                    <li>
                        <a href="/ke-toan/dashboard">
                            <img src="/images/img4.png" alt="Dashboard" style="width: 18px; height: 18px; margin-right: 12px;"> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/ke-toan/quan-ly-hoa-don" class="active">
                            <img src="/images/hoa-don.png" alt="Qu·∫£n l√Ω h√≥a ƒë∆°n" style="width: 18px; height: 18px; margin-right: 12px;"> Qu·∫£n l√Ω h√≥a ƒë∆°n
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2>Qu·∫£n l√Ω h√≥a ƒë∆°n</h2>
                </div>
                
                <div class="header-right">
                    <div class="user-info">
                        <span>Xin ch√†o, <strong th:text="${username}">K·∫ø to√°n</strong></span>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-danger">ƒêƒÉng xu·∫•t</button>
                        </form>
                    </div>
                </div>
            </header>
            <main class="page-content">
                <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
                
                <!-- Import errors detail -->
                <div th:if="${importErrors}" class="alert alert-warning">
                    <strong>Chi ti·∫øt l·ªói import:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li th:each="err : ${importErrors}" th:text="${err}"></li>
                    </ul>
                </div>
                <div class="content-header">
                    <div class="search-bar">
                        <form th:action="@{/ke-toan/quan-ly-hoa-don}" method="get">
                            <input type="text" name="search" th:value="${search}" placeholder="T√¨m ki·∫øm..." class="form-control">
                            <button type="submit" class="btn btn-primary">T√¨m ki·∫øm</button>
                        </form>
                    </div>
                    <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <!-- Import/Export Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-info dropdown-toggle" type="button" onclick="toggleImportExportDropdown()">
                                üì• Import / Export
                            </button>
                            <ul class="dropdown-menu" id="importExportDropdownMenu">
                                <li><a class="dropdown-item" th:href="@{/ke-toan/quan-ly-hoa-don/export/excel(search=${search})}">üìä Xu·∫•t Excel</a></li>
                                <li><a class="dropdown-item" th:href="@{/ke-toan/quan-ly-hoa-don/export/pdf(search=${search})}">üìÑ Xu·∫•t PDF</a></li>
                                <li style="border-top: 1px solid #e2e8f0; margin: 5px 0;"></li>
                                <li><a class="dropdown-item" th:href="@{/ke-toan/quan-ly-hoa-don/import/template}">üìã T·∫£i m·∫´u Import</a></li>
                                <li><a class="dropdown-item" href="#" onclick="document.getElementById('importModal').style.display='flex'; return false;">üì• Import t·ª´ Excel</a></li>
                            </ul>
                        </div>
                        
                        <!-- Create Invoice Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-success dropdown-toggle" type="button" id="createInvoiceDropdown" onclick="toggleDropdown()">
                                <img src="/images/add.png" alt="T·∫°o h√≥a ƒë∆°n" style="width: 18px; height: 18px; filter: brightness(0) invert(1); margin-right: 0px; vertical-align: middle;"> T·∫°o h√≥a ƒë∆°n
                            </button>
                            <ul class="dropdown-menu" id="dropdownMenu">
                                <li><a class="dropdown-item" href="/ke-toan/quan-ly-hoa-don/tao-hoa-don?loai=dien_nuoc">‚ö° ƒêi·ªán n∆∞·ªõc</a></li>
                                <li><a class="dropdown-item" href="/ke-toan/quan-ly-hoa-don/tao-hoa-don?loai=dich_vu">üõ†Ô∏è D·ªãch v·ª•</a></li>
                                <li><a class="dropdown-item" href="/ke-toan/quan-ly-hoa-don/tao-hoa-don?loai=sua_chua">üîß S·ª≠a ch·ªØa</a></li>
                                <li><a class="dropdown-item" href="/ke-toan/quan-ly-hoa-don/tao-hoa-don?loai=phat">‚ÄºÔ∏è Ph·∫°t</a></li>
                                <li><a class="dropdown-item" href="/ke-toan/quan-ly-hoa-don/tao-hoa-don?loai=khac">üìÑ Kh√°c</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>M√É H√ìA ƒê∆†N</th>
                                <th>M√É H·ªò</th>
                                <th>LO·∫†I H√ìA ƒê∆†N</th>
                                <th>S·ªê TI·ªÄN</th>
                                <th>H·∫†N THANH TO√ÅN</th>
                                <th>TR·∫†NG TH√ÅI</th>
                                <th>THAO T√ÅC</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${hoaDonList.isEmpty()}">
                                <td colspan="7" style="text-align: center; color: #94a3b8;">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o</td>
                            </tr>
                            <tr th:each="hoaDon : ${hoaDonList}">
                                <td th:text="${hoaDon.maHoaDon}">HD001</td>
                                <td th:text="${hoaDon.maHo}">H001</td>
                                <td>
                                    <span th:switch="${hoaDon.loaiHoaDon}">
                                        <span th:case="'dien_nuoc'" style="color: #4894ec;">ƒêi·ªán n∆∞·ªõc</span>
                                        <span th:case="'dich_vu'" style="color: #ec4899;">D·ªãch v·ª•</span>
                                        <span th:case="'sua_chua'" style="color: #8b5cf6;">S·ª≠a ch·ªØa</span>
                                        <span th:case="'phat'" style="color: #ef4444;">Ph·∫°t</span>
                                        <span th:case="'khac'" style="color: #6b7280;">Kh√°c</span>
                                        <span th:case="null" style="color: #6b7280;"> Kh√°c</span>
                                        <span th:case="''" style="color: #6b7280;"> Kh√°c</span>
                                        <span th:case="*" style="color: #6b7280;"> Kh√°c</span>
                                    </span>
                                </td>
                                <td>
                                    <span th:text="${#numbers.formatDecimal(hoaDon.soTien != null ? hoaDon.soTien : 0, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">0 VNƒê</span>
                                </td>
                                <td th:text="${hoaDon.hanThanhToan != null ? #temporals.format(hoaDon.hanThanhToan, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</td>
                                <td>
                                    <span class="badge" 
                                          th:classappend="${hoaDon.trangThai == 'da_thanh_toan'} ? 'badge-success' : (${hoaDon.trangThai == 'qua_han'} ? 'badge-danger' : 'badge-warning')">
                                        <span th:switch="${hoaDon.trangThai}">
                                            <span th:case="'da_thanh_toan'">‚úì ƒê√£ thanh to√°n</span>
                                            <span th:case="'chua_thanh_toan'">‚è≥ Ch∆∞a thanh to√°n</span>
                                            <span th:case="'qua_han'">‚ö†Ô∏è Qu√° h·∫°n</span>
                                            <span th:case="*">Ch∆∞a thanh to√°n</span>
                                        </span>
                                    </span>
                                </td>
                                <td class="actions">
                                    <form th:action="@{/ke-toan/quan-ly-hoa-don/xoa/{id}(id=${hoaDon.maHoaDon})}" method="post" style="display: inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?')">X√≥a</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="importModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üì• Import h√≥a ƒë∆°n t·ª´ Excel</h3>
                <button type="button" class="modal-close" onclick="document.getElementById('importModal').style.display='none'">&times;</button>
            </div>
            <form th:action="@{/ke-toan/quan-ly-hoa-don/import}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="importFile">Ch·ªçn file Excel (.xlsx):</label>
                        <input type="file" id="importFile" name="file" accept=".xlsx,.xls" required 
                               class="form-control" style="padding: 10px; margin-top: 8px;">
                    </div>
                    <div class="import-info" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #0369a1;">üìã H∆∞·ªõng d·∫´n:</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #0c4a6e;">
                            <li>T·∫£i file m·∫´u tr∆∞·ªõc khi import</li>
                            <li>ƒêi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*)</li>
                            <li>ƒê·ªãnh d·∫°ng ng√†y: dd/MM/yyyy</li>
                            <li>Lo·∫°i h√≥a ƒë∆°n: dien_nuoc, dich_vu, sua_chua, phat, khac</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <a th:href="@{/ke-toan/quan-ly-hoa-don/import/template}" class="btn btn-secondary">
                        üìã T·∫£i m·∫´u
                    </a>
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('importModal').style.display='none'">
                        H·ªßy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üì• Import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-header h3 {
            margin: 0;
            color: #1e293b;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: #ef4444;
        }
        .btn-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-1px);
        }
        .btn-outline {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-outline:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569, #334155);
        }
        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            color: #92400e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>

    <script th:src="@{/js/script.js}"></script>
    <script>
        function toggleDropdown() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            const importExportMenu = document.getElementById('importExportDropdownMenu');
            importExportMenu.classList.remove('show');
            dropdownMenu.classList.toggle('show');
        }
        
        function toggleImportExportDropdown() {
            const importExportMenu = document.getElementById('importExportDropdownMenu');
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.classList.remove('show');
            importExportMenu.classList.toggle('show');
        }
        
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('.dropdown');
            let clickedInside = false;
            
            dropdowns.forEach(function(dropdown) {
                if (dropdown.contains(event.target)) {
                    clickedInside = true;
                }
            });
            
            if (!clickedInside) {
                document.getElementById('dropdownMenu').classList.remove('show');
                document.getElementById('importExportDropdownMenu').classList.remove('show');
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('importModal').addEventListener('click', function(event) {
            if (event.target === this) {
                this.style.display = 'none';
            }
        });
    </script>
</body>
</html>

