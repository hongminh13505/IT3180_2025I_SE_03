<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê - Quản lý chung cư</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>BLUE MOON</h3>
                <p class="role-badge">Kế toán</p>
            </div>
            
            <nav class="sidebar-menu">
                <ul>
                    <li>
                        <a href="/ke-toan/dashboard">
                            <img src="/images/img4.png" alt="Dashboard" style="width: 18px; height: 18px; margin-right: 12px;"> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/ke-toan/quan-ly-hoa-don">
                            <img src="/images/hoa-don.png" alt="Quản lý hóa đơn" style="width: 18px; height: 18px; margin-right: 12px;"> Quản lý hóa đơn
                        </a>
                    </li>
                    <li>
                        <a href="/ke-toan/thong-ke" class="active">
                            <img src="/images/img4.png" alt="Thống kê" style="width: 18px; height: 18px; margin-right: 12px;"> Thống kê
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                    <h2>Thống kê</h2>
                </div>
                
                <div class="header-right">
                    <div class="user-info">
                        <span>Xin chào, <strong th:text="${username}">Kế toán</strong></span>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-danger">Đăng xuất</button>
                        </form>
                    </div>
                </div>
            </header>
            <main class="page-content">
                <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
                
                <div class="content-section" style="margin-bottom: 24px;">
                    <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">Bộ lọc thời gian</h3>
                    <form th:action="@{/ke-toan/thong-ke}" method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #475569;">Năm</label>
                            <input type="number" name="year" th:value="${year}" min="2020" max="2100" class="form-control" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #475569;">Tháng (tùy chọn)</label>
                            <select name="month" class="form-control">
                                <option value="">Tất cả</option>
                                <option th:each="m : ${#numbers.sequence(1, 12)}" 
                                        th:value="${m}" 
                                        th:text="'Tháng ' + ${m}"
                                        th:selected="${month != null and month == m}"></option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #475569;">Loại xem</label>
                            <select name="viewType" class="form-control">
                                <option value="thang" th:selected="${viewType == 'thang'}">Theo tháng</option>
                                <option value="nam" th:selected="${viewType == 'nam'}">Theo năm</option>
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Xem thống kê</button>
                        </div>
                    </form>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="/images/money.png" alt="Tổng thu" style="width: 24px; height: 24px;">
                        </div>
                        <div class="stat-details">
                            <h3 th:text="${#numbers.formatDecimal(tongThuNam != null ? tongThuNam : 0, 0, 'COMMA', 0, 'POINT')}">0</h3>
                            <p>Tổng thu (VNĐ)</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="/images/money.png" alt="Tổng nợ" style="width: 24px; height: 24px;">
                        </div>
                        <div class="stat-details">
                            <h3 th:text="${#numbers.formatDecimal(tongNoNam != null ? tongNoNam : 0, 0, 'COMMA', 0, 'POINT')}">0</h3>
                            <p>Tổng nợ (VNĐ)</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="/images/hoa-don.png" alt="Tổng hóa đơn" style="width: 24px; height: 24px;">
                        </div>
                        <div class="stat-details">
                            <h3 th:text="${tongHoaDon != null ? tongHoaDon : 0}">0</h3>
                            <p>Tổng hóa đơn</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-two-column" th:if="${viewType == 'thang'}">
                    <div class="content-section column-left">
                        <div class="section-header">
                            <h3>Biểu đồ thu chi theo tháng</h3>
                        </div>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="content-section column-right">
                        <div class="section-header">
                            <h3>Biểu đồ số lượng hóa đơn</h3>
                        </div>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <canvas id="invoiceCountChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-two-column" th:if="${viewType == 'nam'}">
                    <div class="content-section column-left">
                        <div class="section-header">
                            <h3>Biểu đồ thu chi theo năm</h3>
                        </div>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="content-section column-right">
                        <div class="section-header">
                            <h3>Biểu đồ số lượng hóa đơn</h3>
                        </div>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <canvas id="invoiceCountChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="content-section" th:if="${month != null and loaiLabels != null}">
                    <div class="section-header">
                        <h3>Thống kê theo loại hóa đơn - Tháng <span th:text="${month}"></span>/<span th:text="${year}"></span></h3>
                    </div>
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="loaiChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script th:src="@{/js/script.js}"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const labels = /*[[${labels}]]*/ [];
            const tongThuData = /*[[${tongThuData}]]*/ [];
            const tongNoData = /*[[${tongNoData}]]*/ [];
            const soLuongData = /*[[${soLuongData}]]*/ [];
            
            if (labels.length > 0) {
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Tổng thu',
                                data: tongThuData,
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Tổng nợ',
                                data: tongNoData,
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + 
                                                new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                const invoiceCtx = document.getElementById('invoiceCountChart');
                if (invoiceCtx) {
                    new Chart(invoiceCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Số lượng hóa đơn',
                                data: soLuongData,
                                backgroundColor: 'rgba(14, 165, 233, 0.8)',
                                borderColor: 'rgba(14, 165, 233, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Số lượng: ' + context.parsed.y;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            const loaiLabels = /*[[${loaiLabels}]]*/ null;
            const loaiTongThuData = /*[[${loaiTongThuData}]]*/ null;
            const loaiTongNoData = /*[[${loaiTongNoData}]]*/ null;
            
            if (loaiLabels && loaiLabels.length > 0) {
                const loaiCtx = document.getElementById('loaiChart');
                if (loaiCtx) {
                    new Chart(loaiCtx, {
                        type: 'doughnut',
                        data: {
                            labels: loaiLabels,
                            datasets: [{
                                label: 'Tổng thu',
                                data: loaiTongThuData,
                                backgroundColor: [
                                    'rgba(14, 165, 233, 0.8)',
                                    'rgba(236, 72, 153, 0.8)',
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(107, 114, 128, 0.8)'
                                ],
                                borderColor: [
                                    'rgba(14, 165, 233, 1)',
                                    'rgba(236, 72, 153, 1)',
                                    'rgba(139, 92, 246, 1)',
                                    'rgba(239, 68, 68, 1)',
                                    'rgba(107, 114, 128, 1)'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return label + ': ' + 
                                                new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>

